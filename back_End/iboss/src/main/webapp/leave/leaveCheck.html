<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Hugo 0.98.0">
  <title>iBoss</title>

  <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="../jquery-3.6.0.js"></script>
  <link href="../css/dashboard.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/navCss.css">

  <!-- 套用leaveCheckCss.css -->
  <link rel="stylesheet" href="../css/leaveCheckCss.css">
  
<!--   套用jSignature -->
  <script  src="../js/flashcanvas.js"></script>
  <script  src="../js/jSignature.min.js"></script>


  
  <style>


    
  </style>



</head>

<body>

  
  <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-7" href="../home/home.html"><img src="../image/iblogow.png"
        width="100px" height="67px">iBoss</a>

    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse"
      data-bs-target="#sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

     <div id="user">
      <a href="../profile/profile.html">
        <span class="circle" style=" color: white;"></span>
      </a>
    </div>
  </header>

  <div class="container-fluid">
    <div class="row">
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="../home/home.html">
                <span data-feather="home" class="align-text-bottom"></span>
                首頁
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../profile/profile.html">
                <span data-feather="user" class="align-text-bottom"></span>
                個人資料
              </a>
            </li>
            <div class="personnel">
            <li class="nav-item">
              <a class="nav-link" href="../profile/createProfile.html">
                <span data-feather="user-plus" class="align-text-bottom iconPersonnel"></span>
                新進員工建檔
              </a>
            </li>
            </div>
            <li class="nav-item">
              <a class="nav-link" href="../punchCard/punchRecord.html">
                <span data-feather="clock" class="align-text-bottom"></span>
                打卡紀錄
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../calendar/calendar.html">
                <span data-feather="calendar" class="align-text-bottom"></span>
                行事曆
              </a>
            </li>

            <li class="nav-item">
              <button class="nav-link" href="#" id="annoucement" onclick="displayDiv('divAnnoucement')">
                <span data-feather="edit" class="align-text-bottom"></span>
                公告查詢
              </button>
            </li>
            <div id="divAnnoucement">
              <ul>
                <li class="nav-item">
                  <a class="nav-link annoucements " href="../announcement/annoucementList.html">
                    公告列表
                  </a>
                </li>
                <div class="boss">
                  <li class="nav-item">
                    <a class="nav-link annoucements" href="../announcement/announcementInsert.html">
                      發布公告
                    </a>
                  </li>
                </div>
              </ul>
            </div>

            <li class="nav-item">
              <button class="nav-link" href="#" id="leave" onclick="displayDiv('divLeave')">
                <span data-feather="clipboard" class="align-text-bottom"></span>
                請假
              </button>
            </li>
            <div id="divLeave">
              <ul>
                <li class="nav-item">
                  <a class="nav-link leaves " href="../leave/leaveApply.html">
                    填寫假單
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link leaves" href="../leave/leaveRecord.html">
                    假單查詢
                  </a>
                </li>
                <div class="boss">
                  <li class="nav-item">
                    <a class="nav-link leaves" href="../leave/leaveCheck.html">
                      假單審核
                    </a>
                  </li>
                </div>
              </ul>
            </div>
            <li class="nav-item">
              <a class="nav-link" href="../pay/pay.html">
                <span data-feather="dollar-sign" class="align-text-bottom"></span>
                薪資查詢
              </a>
            </li>
            <li class="nav-item">
              <button class="nav-link" href="#" id="order" onclick="displayDiv('divOrder')">
                <span data-feather="shopping-cart" class="align-text-bottom"></span>
                訂餐
              </button>
            </li>
            <div id="divOrder">
              <ul>
              <div class="generalAffairs">
                  <li class="nav-item">
                    <a class="nav-link orders" href="../restaurant/restaurant-choice.html">
                      選擇餐廳
                    </a>
                  </li>
                </div>
                <li class="nav-item">
                  <a class="nav-link orders" href="../restaurant/restaurant.html">
                    點餐
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link orders" href="../restaurant/restaurant-record.html">
                    訂餐查詢
                  </a>
                </li>
                <div class="generalAffairs">
                  <li class="nav-item">
                    <a class="nav-link orders" href="../restaurant/restaurant-manager.html">
                      上傳餐廳
                    </a>
                  </li>
                </div>
                <div class="generalAffairs">
                  <li class="nav-item">
                    <a class="nav-link orders" href="../restaurant/restaurant-today.html">
                      今日訂餐總表
                    </a>
                  </li>
                </div>
              </ul>
            </div>
            <li class="nav-item">
              <button class="nav-link" href="" id="tool" onclick="displayDiv('divTool')">
                <span data-feather="tool" class="align-text-bottom"></span>
                器材
              </button>
            </li>

            <div id="divTool">
              <ul>
                <li class="nav-item">
                  <a class="nav-link tools" href="../equipment/equipment_new.html">
                    租借申請單
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link tools" href="../equipment/equipment_fixnew.html">
                    維修申請單
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link tools" href="../equipment/equipment.html">
                    紀錄查詢
                  </a>
                </li>
                <div class="generalAffairs">
                  <li class="nav-item">
                    <a class="nav-link tools" href="../equipment/equipment_check.html">
                      進度追蹤
                    </a>
                  </li>
                </div>
              </ul>
            </div>
            <li class="nav-item">
              <button class="nav-link" href="#" id="package" onclick="displayDiv('divPackage')">
                <span data-feather="box" class="align-text-bottom"></span>
                包裹收發
              </button>
            </li>
            <div id="divPackage">
              <ul>
                <div class="receiveRoom">
                  <li class="nav-item">
                    <a class="nav-link packages" href="../receive/receive_get.html">
                      包裹登錄
                    </a>
                  </li>
                </div>
                <li class="nav-item">
                  <a class="nav-link packages" href="../receive/receive_push.html">
                    寄件申請
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link packages" href="../receive/receive.html">
                    包裹查詢
                  </a>
                </li>
                <div class="receiveRoom">
                  <li class="nav-item">
                    <a class="nav-link packages" href="../receive/receive_check.html">
                      進度追蹤
                    </a>
                  </li>
                </div>
              </ul>
            </div>
            <li class="nav-item">
              <a class="nav-link" href="../webRTC/webrtc.html">
                <span data-feather="video" class="align-text-bottom"></span>
                視訊會議
              </a>
            </li>
            <div class="boss">
            <li class="nav-item">
              <a class="nav-link" href="">
              <span data-feather="camera" class="align-text-bottom iconBoss"></span>
                即時影像
              </a>
            </li>
            </div>
            <li class="nav-item" id="logout">
              <a class="nav-link" href="../index.html">
                <span data-feather="log-out" class="align-text-bottom"></span>
                登出
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- 內容放置處 -->
      <!-- 主管審核假單內容 -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        
        <!--標題-->
      	 <h1>請假審核</h1>
      	 <hr>
        
        <div>
      
        <table class="table table-striped" >
          <thead>
            <tr>
              <th scope="col" class="leaveBoss">選取</th>
              <th scope="col">假單編號</th>
              <th scope="col">申請人</th>
              <th scope="col">假別</th>
              <th scope="col">請假時數</th>
              <th scope="col">事由</th>
              <th scope="col" style="width:40rem;">請假時間</th>
            </tr>
          </thead>
          <tbody id="tbodyCheck"></tbody>
        </table>            
          
          
         <!-- 簽名區塊 -->
        <div id="drawer">
        	<h4>※職員請假時間超過2週，請進行批次電子簽名確認</h4>
	        <div id="signature"></div>
	        <div id="btnDiv">
	        	<button id="btnSignOk" class="btn" type="button">確認</button> 
	            <button id="btnReset" class="btn" type="button">重簽</button>  
	        </div>
    	</div>
          
          
          <!-- 按鈕區塊 -->
          <div id="leaveCheckBtn">
          
          <!-- alert 的按鈕 -->
			<button type="button" id="btnCheckYES" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#CheckYES">
			  核准
			</button>
			<button type="button" id="btnCheckNO" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#CheckNO">
			  駁回
			</button>

          </div>

        </div>
        
        <!-- alert 的內容    -->
		  <div class="modal fade" id="CheckYES" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		    <div class="modal-dialog modal-dialog-centered">      
		      <div class="modal-content">        
		        <!-- <div class="modal-header">
		          header 內含 hr 樣式
		        </div> -->
		        <div class="modal-body">
		          <div class="alertContent">假單已審核成功！</div>          
		          <div class="alertClose">
		            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
		            </button>
		          </div>          
		        </div>      
		      </div>
		    </div>
		  </div>
		  
		 <!-- alert 的內容    -->
		  <div class="modal fade" id="CheckNO" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		    <div class="modal-dialog modal-dialog-centered">      
		      <div class="modal-content">        
		        <!-- <div class="modal-header">
		          header 內含 hr 樣式
		        </div> -->
		        <div class="modal-body">
		          <div class="alertContent">假單已駁回！</div>          
		          <div class="alertClose">
		            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
		            </button>
		          </div>          
		        </div>      
		      </div>
		    </div>
		  </div>
		  
		  
        
      </main>


    </div>
  </div>

  <script src="../assets/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"
    integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
    crossorigin="anonymous"></script>
    <script src="../js/dashboard.js"></script>
    
  <!-- 引用cookie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

  <script src="../js/navScript.js"></script>

  <!-- 內容的script -->
  <script>

  
var bossempid= $.cookie('session_id');
//主管職位id=1
var positionid= 1;
var dataFromServer ={} ;
var dataToServer ={} ;
  
//右上角ICON姓名
$.ajax({
  url: `/profiles/select/${bossempid}`,
  dataType: "JSON",
  success: function (data) {
    var nickname = (data.name).substr(-2, 2);
    $('.circle').text(nickname);
  }
});

//重簽按鈕
$('#btnReset').on("click", function() {	
	 $("#signature").jSignature("reset");
});

//確認按鈕
$('#btnSignOk').on("click", function() {	
	$('#leaveCheckBtn').css('display','block');   
});
  
  //取得部門職員待簽核資料
  $.ajax({
		
      url: `/api/LeaveLists/${bossempid}/${positionid}`,
      dataType: 'json',
      success: function (data) {
    	  for(i=0;i<data.length;i++){
    		$('#tbodyCheck').append(`<tr>`+
		 ` <td>`+
		 //預設每筆撈出的資料value=i
		 ` <input type="checkbox" class="classCheckbox" name="" id="" value="${i}">`+
         ` </td>`+
         ` <td class="classLeaveID">${data[i].leaveid}</td> `+
         ` <td>${data[i].emp.name}</td> `+
         ` <td>${data[i].leavetype.leavetype}</td> `+
         ` <td class="hour${i}">${data[i].leavehour}</td> `+
         ` <td>${data[i].leavereason}</td>   `+
         ` <td>${(new Date(data[i].leavestartdate)).toLocaleString().split(":")[0]}:${(new Date(data[i].leavestartdate)).toLocaleString().split(":")[1]}  -  ${(new Date(data[i].leaveenddate)).toLocaleString().toLocaleString().split(":")[0]}:${(new Date(data[i].leaveenddate)).toLocaleString().toLocaleString().split(":")[1]}</td> `+
		 ` </tr>`);
    		
    		if(data[i].leavehour>112){
    			$(`.hour${i}`).css('color', 'red');
    		}
    	  }
    	  
    	 
    	      	  
    	//若有請假時數超過2週，需電子簽名
    	  $('.classCheckbox').on("click", function() {	
    		  if($('input[type="checkbox"]:checked').length==0){
    			  $("#signature").empty();  
            	  $('#drawer').css('display','none'); 
            	  $("#btnUndo").remove();
    		  }
    		$('input[type="checkbox"]:checked').each(function (){
    			if(data[this.value].leavehour>112){
            		  if($("#signature").html()==""){
            			  $('#drawer').css('display','block');
            			  $("#signature").jSignature(
             				     {'UndoButton':true,
             				     lineWidth:"3",
             				     color:"gray"});
         				 $("input[type='button'][value='Undo']").prop('id','btnUndo');
         				 $('#btnUndo').val('清除上一筆');
         				 $('#btnUndo').appendTo($("#btnDiv"));
         				 $('#leaveCheckBtn').css('display','none');
            		  }
          	  	}else if(data[this.value].leavehour<=112){

          	  	$("#signature").empty();
          	    $('#drawer').css('display','none');
          	  	$("#btnUndo").remove();
          	  	} 
    		})         	  
    	  });
    	  //將data存入dataFromServer
    	  dataFromServer=data;    	  
    	  
    	  //若無待審核項目，表格填入"無待審核項目"
    	  if($('#tbodyCheck').text()==""&& data.length==0){
    		  $('#leaveCheckBtn').css('display','none');    		 
    		  $('#tbodyCheck').append(`<tr><td colspan="7">無待審核項目</td></tr>`)
    	  	  
    	  };
    	  
    	   	     	  
    	  
      }
  
  });
  
  
  
  //核准按鈕
  $("#btnCheckYES").on("click", function() {	  	
		 
		 $('input[type="checkbox"]:checked').each(function (){
			 //取得該筆在dataFromServer的次序,並存入dataToServer
			 var n = $(this).val();
			 dataToServer=dataFromServer[n];
			 //改變狀態:2(待人事部審核)
			 dataToServer.status.statusid=2;
		     //更新員工
			 $.ajax({
			  type: "put",
			     url: `/api/LeaveLists/${n}`,
			     data : JSON.stringify(dataToServer),
			     contentType: "application/json",
			     success: function (data) {
			   	   console.log(data+" ok");
			   				   	    	  
			     }
			 });
		 		
		 });

		 
	  });
  
  //關閉alert視窗後重新整理
  $('.btn-close').on("click", function() {
	  location.reload();
  });
  
  //駁回按鈕
  $("#btnCheckNO").on("click", function() {	  	
		 
		 $('input[type="checkbox"]:checked').each(function (){
			//取得該筆在dataFromServer的次序,並存入dataToServer
			 var n = $(this).val();
			 dataToServer=dataFromServer[n];
			 //改變狀態:5(主管已駁回)
			 dataToServer.status.statusid=5;
		  
			 $.ajax({
			  type: "put",
			     url: `/api/LeaveLists/${n}`,
			     data : JSON.stringify(dataToServer),
			     contentType: "application/json",
			     success: function (data) {
			   	   console.log(data+" ok");
			   				   	    	  
			     }
			 });
		 		
		 });
		
	  });
  
 

  


  </script>

  
</body>

</html>